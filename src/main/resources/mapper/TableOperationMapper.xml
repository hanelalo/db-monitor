<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.github.starter.dbmonitor.mapper.TableOperationMapper">
    
    <!-- 获取数据库中所有表名 -->
    <select id="getAllTableNames" resultType="java.lang.String">
        SELECT table_name FROM information_schema.tables 
        WHERE table_schema = DATABASE() AND table_type = 'BASE TABLE'
    </select>
    
    <!-- 使用SHOW TABLES获取表名 -->
    <select id="getTableNamesByShow" resultType="java.lang.String">
        SHOW TABLES
    </select>
    
    <!-- 检查表是否存在 -->
    <select id="checkTableExists" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM information_schema.tables 
        WHERE table_schema = DATABASE() AND table_name = #{tableName}
    </select>
    
    <!-- 检查表是否存在(通过查询) - 注意：此方法已弃用，建议使用checkTableExists -->
    <select id="checkTableExistsByQuery" parameterType="java.lang.String" resultType="java.lang.Integer">
        <!-- 此查询存在SQL注入风险，仅在表名已经过安全验证后使用 -->
        SELECT 1 FROM ${tableName} LIMIT 1
    </select>
    
    <!-- 获取表的列信息 -->
    <select id="getTableColumns" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT column_name FROM information_schema.columns 
        WHERE table_schema = DATABASE() AND table_name = #{tableName}
    </select>
    
    <!-- 查询表的增量数据 - 注意：此方法存在SQL注入风险，仅在参数已经过安全验证后使用 -->
    <select id="queryTableIncrement" resultType="java.lang.Long">
        <!-- 表名和列名使用字符串替换，存在SQL注入风险，必须在应用层进行安全验证 -->
        SELECT COUNT(*) FROM ${tableName}
        WHERE ${timeColumn} >= #{startTime} AND ${timeColumn} &lt; #{endTime}
    </select>
    
    <!-- 从INFORMATION_SCHEMA获取平均行大小 -->
    <select id="getAvgRowSizeFromInformationSchema" parameterType="java.lang.String" resultType="java.lang.Long">
        SELECT AVG_ROW_LENGTH FROM INFORMATION_SCHEMA.TABLES 
        WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = #{tableName}
    </select>
    
    <!-- 从SHOW TABLE STATUS获取表状态信息 -->
    <select id="getTableStatusInfo" parameterType="java.lang.String" resultType="java.util.Map">
        SHOW TABLE STATUS LIKE #{tableName}
    </select>
    
    <!-- 获取表的结构信息用于估算行大小 -->
    <select id="getTableSchemaInfo" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT COLUMN_NAME, DATA_TYPE, 
               IFNULL(CHARACTER_MAXIMUM_LENGTH, 0) as CHAR_LENGTH, 
               IFNULL(NUMERIC_PRECISION, 0) as NUM_PRECISION, 
               IFNULL(NUMERIC_SCALE, 0) as NUM_SCALE 
        FROM INFORMATION_SCHEMA.COLUMNS 
        WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = #{tableName}
    </select>
</mapper>